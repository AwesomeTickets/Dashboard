[api]:    https://github.com/AwesomeTickets/Dashboard/blob/master/doc/api.md
[deploy]: http://stevennl.com/post/awesometickets-architecture-and-docker-deployment/

# 软件设计文档

[项目架构与部署方案][deploy]

### 技术特点

- 使用java开发，全面向对象。
- 提供院线RESTful接口，支持前端多样化。
- 后台部署分布式，支持高并发。
- 集成、部署使用docker容器，过程自动化，降低人力成本。
- 使用J2EE架构，Spring-SpringMVC-Hibernate框架。
	- Spring框架提供了注解、AOP等，提高开发效率。
	- SpringMVC轻量化，本后台接口服务并不需要渲染页面等。
	- Hibernate提供了数据抽象，作为ORM框架提高了小规模服务开发迭代效率。
- 配置脱离运行代码，提高开发测试效率。

### 项目目录结构

```
- ServiceServer
	- src
		- main
			- java
				- com.awesometickets
					- business
						- entities
							- repositories
						- services
					- config
					- util
					- web
						- controller
							- response
						- interceptor
			- resources
			- webapp
				- WEB-INF
		- test

```

## 功能

作为院线API后台服务程序，提供院线接口供前端调用。
详见[接口文档][api]。

## 性能

- 每次请求应尽量在3秒内完成响应
- 服务程序应当保持时刻在线

## 输入项

详见[接口文档][api]。

## 输出项

详见[接口文档][api]。

## 算法

用户密码保存使用MD5单向加密。

## 流程逻辑

### 拦截器

#### 缓存
```
- src/main/java
	- com.awesometickets.web.interceptor.CacheInterceptor
```

所有请求首先经过缓存拦截器，如果请求在缓存中有，则直接返回内容。

### 接口路由

#### 返回值

```
- src/main/java
	- com.awesometickets.web.controller.response
```

- RestResponse：RESTful服务接口的基类，由LinkedHashMap继承而来，Spring可直接渲染为JSON对象返回。
- ErrorResponse：继承自RestResponse，当发生错误时返回，有code、info属性，用于错误提示。
- CollectionResponse：继承自RestResponse，用于返回集合。有count和data属性。
- ErrorStatus：定义了本服务所出现的所有错误类型及提示信息。

#### 控制器

使用Spring注解容器Controller定义。

- RequestMapping注解：定义一条路径映射方法，可以通过属性设置定义路径、HTTP方法、返回值类型。
- PathVariable注解：可直接获取定义路径中的路径变量。
- RequestParam注解：可直接获取请求中的参数。

	```
	- src/main/java
		- com.awesometickets.web.controller
	```

- CinemaController：提供影院信息接口。
- CinemaHallCOntroller：提供影院内影厅信息的接口。
- MovieController：提供电影信息接口。
- MovieOnShowController：提供上映电影信息接口。
- SeatController：提供座位信息接口。
- SmsController：提供手机短信相关服务接口。
- TicketController：提供票务信息接口。
- UserController：提供用户服务接口，包括注册登录等。
- ViewController：提供返回页面接口。

### 工具类

```
- src/main/java
	- com.awesometickets.util
```

#### DateUtil

- 使用Calendar计算nextDate

#### LogUtil

- logReq方法传入logger和request对象，按照格式输出日志。

### 数据库

```
- src/main/java
	- com.awesometickets.business.entities.repositories
```

#### CinemaHallRepository

- 通过cinemaHallId查找影厅信息，包括所在影院、影厅名。
- 通过cinemaHallId查找影厅座位情况。

#### MovieOnShowRepository

- 通过movieId、cinemaHallId、showDate、showTime查找上映电影。
- 通过movieId、showDates查找上映该电影的影院。
- 通过movieId、showDate、cinemaId查找某日上映电影。
- 通过movieId、showDate、cinemaId查找某日上映简介。

#### MovieRepository

- 通过status查找电影。
- 获取大海报的电影信息以及海报图片。
- 通过movieId获取电影详细信息。

#### SeatRepository

- 通过movieOnShowId和available查找可用/不可用座位
- 通过ticketId查找票中座位。
- 通过row、col、movieOnShowId查找特定座位信息。
- 通过phoneNum查找票务信息。

#### TicketRepository

- 通过票务码code查找票信息。
- 通过票务码code查找持票用户信息。

#### UserRepository

- 通过phoneNum查找用户。

## 存储分配

- 各表内容都存储在 awesome_tickets 数据库中。
- 拦截器缓存存储在Redis中。
